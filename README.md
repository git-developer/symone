# SYMONE
SYMONE allows **SY**stem **MON**itoring with **E**ase.

## Key features
SYMONE performs system monitoring tasks:
- Collect information, e.g. about cpu, memory, storage, temperature
- Format, e.g. convert to JSON or CSV
- Publish, e.g. via MQTT

SYMONE is polite and reliable:
- Runs in a Docker container to keep the system clean of dependencies
- Does not need root permissions
- Does her job regularly

## Example
Let's suppose that SYMONE runs on a Raspberry Pi with hostname `raspberry` using the following configuration:

```yaml
---
services:
  symone:
    image: "ckware/symone"
    container_name: "symone"
    hostname: "raspberry"
    init: true
    restart: unless-stopped
    user: "1000:44"
    devices:
      - /dev/vchiq
    volumes:
      - "/lost+found:/mnt/root:ro"
      - "/boot/System Volume Information:/mnt/boot:ro"
    environment:
      MQTT_OPTIONS: '-h broker-host'
```

Result: every 5 minutes, she publishes a JSON message via MQTT to topic `/symone/raspberry/json` on broker `broker-host`:

```json
{
  "process": {
    "load": {
      "average1": 0.98,
      "average5": 0.94,
      "average15": 0.93
    },
    "memory": {
      "total": "996096 kB",
      "free": "98640 kB",
      "available": "672800 kB"
    }
  },
  "storage": {
    "boot": {
      "total": "262128 kB",
      "use": "49263 kB",
      "available": "212866 kB",
      "use_relative": "19 %"
    },
    "root": {
      "total": "14154680 kB",
      "use": "7550664 kB",
      "available": "5999948 kB",
      "use_relative": "56 %"
    }
  },
  "thermal": {
    "thermal_zone0": {
      "temperature": "54.768 °C"
    }
  },
  "video-core": {
    "soc": {
      "temperature": "53.7 °C"
    },
    "core": {
      "voltage": "1.2938 V"
    }
  }
}
```

## Pre-requisites
- A linux system with `docker-compose`.

The Docker Compose [documentation](https://docs.docker.com/compose/install/)
contains a comprehensive guide explaining several install options.
On debian-based systems, `docker-compose` may be installed by calling

```shell
$ sudo apt install docker-compose
```

## Usage
* Create a configuration file `docker-compose.yml` (see the examples and docs for an inspiration)
* Start SYMONE by calling `docker-compose up -d`

## Features
- Collectors:
  - Process: cpu load, memory
  - Storage: storage use
  - Thermal: system temperatures
  - Video Core: temperature, voltage
- Formatters:
  - JSON
  - CSV
- Publishers:
  - MQTT
  - stdout
- Scheduling using a CRON expression

## Configuration
### Docker options
| Option        | Description | Example | Default | Explanation |
| ------------- | ----------- | ------- | ------- | ----------- |
| `user`        | Linux user and group           | `1000:44`                  | _none_ (effectively: `root`) | This option is useful when statistics require a certain user or group. Example: In Pi OS (formerly Raspbian), user `pi` (uid `1000`) in group `video` (gid `44`) has permission to read video core statistics.
| `devices`     | Devices for monitoring         | `/dev/vchiq`               | _none_ | This option is useful when statistics require access to a system device. Example: On a Raspberry Pi, `/dev/vchiq` is required to read video core statistics.
| `volumes`     | Volumes for storage monitoring | `/lost+found:/mnt/root:ro` | _none_ | Storage statistics are collected automatically for anything within `/mnt/`. You don't have to mount a complete partition; it is enough to mount a single file or directory that may be read-only or even unreadable by the running user.
| `hostname`    | Hostname                       | `nas`                      | _none_ (effectively: hostname generated by Docker) | The hostname is used as part of the MQTT topic when the option `MQTT_TOPIC_APPEND_HOSTNAME` is enabled.
| `extra_hosts` | Additional host names          | `broker-host:host-gateway` | _none_ | When the MQTT broker is running on the same host as SYMONE, the host hast to be declared as `host-gateway`.

### Environment variables
#### Frequency
| Option      | Description | Example         | Default |
| ----------- | ----------- | --------------- | ------- |
| `TZ`        | Timezone    | `Europe/Berlin` | _none_  |
| `SCHEDULE`  | Schedule (a [CRON expression](https://github.com/aptible/supercronic/tree/master/cronexpr#implementation)) | `* * * * *`     | `*/5 * * * *` (every 5 minutes) |

#### Formatting
| Option                 | Description                   | Examples        | Default |
| ---------------------- | ----------------------------- | --------------- | ------- |
| `FORMAT_JSON`          | Enable JSON format            | `true`, `false` | `true`  |
| `FORMAT_CSV`           | Enable CSV format             | `true`, `false` | `false` |
| `FORMAT_CSV_SEPARATOR` | Item separator for CSV format | `:`             | `,`     |

#### Publishing
| Option                       | Description                   | Examples            | Default  |
| ---------------------------- | ----------------------------- | ------------------- | -------- |
| `PUBLISH_STDOUT`             | Publish to stdout             | `true`, `false`     | `false`  |
| `PUBLISH_MQTT`               | Publish via MQTT              | `true`, `false`     | `true`   |
| `MQTT_OPTIONS`               | MQTT options                  | `-h broker-host`    | _none_   |
| `MQTT_TOPIC`                 | MQTT topic                    | `system-statistics` | `symone` |
| `MQTT_TOPIC_APPEND_HOSTNAME` | Append hostname to MQTT topic | `true`, `false`     | `true`   |
| `MQTT_TOPIC_APPEND_FORMAT`   | Append format to MQTT topic   | `true`, `false`     | `true`   |

#### Collecting
| Option                     | Description                         | Examples        | Default |
| -------------------------  | ----------------------------------- | --------------- | ------- |
| `COLLECTOR_PROCESS`        | Collect info about system processes | `true`, `false` | `true`  |
| `COLLECTOR_PROCESS_LOAD`   | Collect info about system load      | `true`, `false` | `true`  |
| `COLLECTOR_PROCESS_MEMORY` | Collect info about system memory    | `true`, `false` | `true`  |
| `COLLECTOR_PROCESS_ROOT`   | Root directory for process info     | `/proc`         | `/proc` |
| `COLLECTOR_STORAGE`        | Collect info about storage          | `true`, `false` | `true`  |
| `COLLECTOR_STORAGE_ROOT`   | Root directory for storage          | `/mnt`          | `/mnt`  |
| `COLLECTOR_THERMAL`        | Collect info about thermal          | `true`, `false` | `true`  |
| `COLLECTOR_THERMAL_ROOT`   | Root directory for thermal info     | `/sys/devices/virtual/thermal` | `/sys/devices/virtual/thermal`  |
| `COLLECTOR_VIDEO_CORE`     | Collect vidoe core info             | `true`, `false` | `true`  |

#### Debugging
| Option      | Description             | Examples        | Default |
| ----------  | ----------------------- | --------------- | ------- |
| `DEBUG`     | Enable debug log output | `true`, `false` | `false` |
| `TRACE`     | Enable trace log output | `true`, `false` | `false` |

## Advanced topics
### One-shot run
Example for a one-shot run to stdout (no MQTT):

```shell
docker-compose run --rm -e PUBLISH_MQTT=false -e PUBLISH_STDOUT=true symone /opt/symone/take-sample
```

### Extending SYMONE
SYMONE is prepared to be extended by additional collectors, formatters and publishers.

#### Additional collectors
* Put an executable file within the directory `collect`. This file is a _collector_.
* When SYMONE calls a collector, it may emit 0..n items by calling `${COLLECTOR_PUBLISHER}` for each item and hand over the item as arguments:
  * The last argument is treated as value of the item.
  * The last but one argument is treated as name of the item.
  * All preceding items are treated as group(s) for the item.

#### Additional formatters
* Put an executable file within the directory `format`. This file is a _formatter_.
* When SYMONE calls a formatter, she hands over all collected items as arguments.
  Parts of an item are separated by spaces, quoted as required. Item parts may contain spaces, newlines and special characters.
* The formatter is expected to print the formatted message to standard out.

#### Additional publishers
* Put an executable file within the directory `publish`. This file is a _publisher_.
* When SYMONE calls a publisher, she hands over two arguments:
  1. the format id
  2. the formatted message
* The publisher may publish the message.

### Components
SYMONE integrates the following applications and libraries:

* [Docker Compose](https://docs.docker.com/compose/)
* [jo](https://github.com/jpmens/jo/)
* [jq](https://stedolan.github.io/jq/)
* [Mosquitto](https://mosquitto.org/)
* [Supercronic](https://github.com/aptible/supercronic/)
